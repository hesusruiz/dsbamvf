<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="3344px" preserveAspectRatio="none" style="width:1613px;height:3344px;background:#FFFFFF;" version="1.1" viewBox="0 0 1613 3344" width="1613px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="27.6094" id="_title" style="stroke:none;stroke-width:1.0;" width="370" x="623.25" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="360" x="628.25" y="29.5332">Packet Delivery - HappyPets customer changes PTA</text><rect fill="#FFE4E1" height="3287.0625" style="stroke:none;stroke-width:0.5;" width="429" x="90" y="44.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="28" x="288.5" y="58.1045">User</text><rect fill="#EBFCEF" height="3287.0625" style="stroke:none;stroke-width:0.5;" width="944" x="657.5" y="44.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="95" x="1080" y="58.1045">PacketDelivery</text><rect fill="#FFFFFF" height="262.9219" style="stroke:#181818;stroke-width:1.0;" width="10" x="47" y="800.2266"/><rect fill="#FFFFFF" height="957.7656" style="stroke:#181818;stroke-width:1.0;" width="10" x="243.5" y="475.0078"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="472.5" y="196.1406"/><rect fill="#FFFFFF" height="55.7031" style="stroke:#181818;stroke-width:1.0;" width="10" x="472.5" y="256.8438"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="472.5" y="444.6563"/><rect fill="#FFFFFF" height="63.0547" style="stroke:#181818;stroke-width:1.0;" width="10" x="472.5" y="2563.0547"/><rect fill="#FFFFFF" height="228.1641" style="stroke:#181818;stroke-width:1.0;" width="10" x="708.5" y="2626.1094"/><rect fill="#FFFFFF" height="46.7031" style="stroke:#181818;stroke-width:1.0;" width="10" x="708.5" y="3091.4375"/><rect fill="#FFFFFF" height="126.4063" style="stroke:#181818;stroke-width:1.0;" width="10" x="849.5" y="558.0625"/><rect fill="#FFFFFF" height="700.5469" style="stroke:#181818;stroke-width:1.0;" width="10" x="849.5" y="1432.7734"/><rect fill="#FFFFFF" height="164.8125" style="stroke:#181818;stroke-width:1.0;" width="10" x="1042.5" y="1548.5313"/><rect fill="#FFFFFF" height="99.4063" style="stroke:#181818;stroke-width:1.0;" width="10" x="1160.5" y="2854.2734"/><rect fill="#FFFFFF" height="46.7031" style="stroke:#181818;stroke-width:1.0;" width="10" x="1160.5" y="2984.0313"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="1160.5" y="3061.0859"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="1350.5" y="2953.6797"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="1350.5" y="3030.7344"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="1472.5" y="226.4922"/><rect fill="#FFFFFF" height="132.1094" style="stroke:#181818;stroke-width:1.0;" width="10" x="1472.5" y="312.5469"/><rect fill="#FFFFFF" height="429.7344" style="stroke:#181818;stroke-width:1.0;" width="10" x="1472.5" y="2133.3203"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="1565.5" y="3138.1406"/><rect fill="none" height="2020.2891" style="stroke:#000000;stroke-width:1.5;" width="1533.5" x="10" y="271.8438"/><rect fill="none" height="706.8438" style="stroke:#000000;stroke-width:1.5;" width="1177.5" x="430" y="2506"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="52" x2="52" y1="163.7891" y2="3229.8438"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="147" x2="147" y1="163.7891" y2="3229.8438"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="248" x2="248" y1="163.7891" y2="3229.8438"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="477" x2="477" y1="163.7891" y2="3229.8438"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="713.5" x2="713.5" y1="163.7891" y2="3229.8438"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="854.5" x2="854.5" y1="163.7891" y2="3229.8438"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1047.5" x2="1047.5" y1="163.7891" y2="3229.8438"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1165.5" x2="1165.5" y1="163.7891" y2="3229.8438"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1355.5" x2="1355.5" y1="163.7891" y2="3229.8438"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1477.5" x2="1477.5" y1="163.7891" y2="3229.8438"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1570.5" x2="1570.5" y1="163.7891" y2="3229.8438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58" x="20" y="143.1035">Universal</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="21" y="160.7129">Resolver</text><path d="M34,92.5703 C34,82.5703 52,82.5703 52,82.5703 C52,82.5703 70,82.5703 70,92.5703 L70,118.5703 C70,128.5703 52,128.5703 52,128.5703 C52,128.5703 34,128.5703 34,118.5703 L34,92.5703 " fill="#E2E2F0" style="stroke:#181818;stroke-width:1.5;"/><path d="M34,92.5703 C34,102.5703 52,102.5703 52,102.5703 C52,102.5703 70,102.5703 70,92.5703 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58" x="20" y="3243.377">Universal</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="21" y="3260.9863">Resolver</text><path d="M34,3274.0625 C34,3264.0625 52,3264.0625 52,3264.0625 C52,3264.0625 70,3264.0625 70,3274.0625 L70,3300.0625 C70,3310.0625 52,3310.0625 52,3310.0625 C52,3310.0625 34,3310.0625 34,3300.0625 L34,3274.0625 " fill="#E2E2F0" style="stroke:#181818;stroke-width:1.5;"/><path d="M34,3274.0625 C34,3284.0625 52,3284.0625 52,3284.0625 C52,3284.0625 70,3284.0625 70,3274.0625 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="101" x="94" y="160.7129">Prime Customer</text><ellipse cx="147.5" cy="94.6797" fill="#F7A6A6" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M147.5,102.6797 L147.5,129.6797 M134.5,110.6797 L160.5,110.6797 M147.5,129.6797 L134.5,144.6797 M147.5,129.6797 L160.5,144.6797 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="101" x="94" y="3243.377">Prime Customer</text><ellipse cx="147.5" cy="3254.9531" fill="#F7A6A6" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M147.5,3262.9531 L147.5,3289.9531 M134.5,3270.9531 L160.5,3270.9531 M147.5,3289.9531 L134.5,3304.9531 M147.5,3289.9531 L160.5,3304.9531 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#F7A6A6" height="49.2188" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="75" x="211" y="113.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="218" y="135.1035">Customer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="232.5" y="152.7129">SIOP</text><rect fill="#F7A6A6" height="49.2188" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="75" x="211" y="3228.8438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="218" y="3250.377">Customer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="232.5" y="3267.9863">SIOP</text><rect fill="#F7A6A6" height="49.2188" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="75" x="440" y="113.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="447" y="135.1035">Customer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="51" x="452" y="152.7129">Browser</text><rect fill="#F7A6A6" height="49.2188" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="75" x="440" y="3228.8438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="447" y="3250.377">Customer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="51" x="452" y="3267.9863">Browser</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="661.5" y="143.1035">Packet Delivery</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27" x="697" y="160.7129">PEP</text><path d="M693,100.5703 L693,124.5703 M693,112.5703 L710,112.5703 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="722" cy="112.5703" fill="#92E8C6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="661.5" y="3243.377">Packet Delivery</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27" x="697" y="3260.9863">PEP</text><path d="M693,3268.0625 L693,3292.0625 M693,3280.0625 L710,3280.0625 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="722" cy="3280.0625" fill="#92E8C6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#92E8C6" height="49.2188" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="798.5" y="113.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="805.5" y="135.1035">Packet Delivery</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="19" x="845" y="152.7129">RP</text><rect fill="#92E8C6" height="49.2188" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="798.5" y="3228.8438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="805.5" y="3250.377">Packet Delivery</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="19" x="845" y="3267.9863">RP</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="995.5" y="125.4941">Packet Delivery</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58" x="1015.5" y="143.1035">Universal</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1016.5" y="160.7129">Resolver</text><path d="M1029.5,74.9609 C1029.5,64.9609 1047.5,64.9609 1047.5,64.9609 C1047.5,64.9609 1065.5,64.9609 1065.5,74.9609 L1065.5,100.9609 C1065.5,110.9609 1047.5,110.9609 1047.5,110.9609 C1047.5,110.9609 1029.5,110.9609 1029.5,100.9609 L1029.5,74.9609 " fill="#92E8C6" style="stroke:#181818;stroke-width:1.5;"/><path d="M1029.5,74.9609 C1029.5,84.9609 1047.5,84.9609 1047.5,84.9609 C1047.5,84.9609 1065.5,84.9609 1065.5,74.9609 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="995.5" y="3243.377">Packet Delivery</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58" x="1015.5" y="3260.9863">Universal</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1016.5" y="3278.5957">Resolver</text><path d="M1029.5,3291.6719 C1029.5,3281.6719 1047.5,3281.6719 1047.5,3281.6719 C1047.5,3281.6719 1065.5,3281.6719 1065.5,3291.6719 L1065.5,3317.6719 C1065.5,3327.6719 1047.5,3327.6719 1047.5,3327.6719 C1047.5,3327.6719 1029.5,3327.6719 1029.5,3317.6719 L1029.5,3291.6719 " fill="#92E8C6" style="stroke:#181818;stroke-width:1.5;"/><path d="M1029.5,3291.6719 C1029.5,3301.6719 1047.5,3301.6719 1047.5,3301.6719 C1047.5,3301.6719 1065.5,3301.6719 1065.5,3291.6719 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><rect fill="#92E8C6" height="49.2188" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="1109.5" y="113.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="1116.5" y="135.1035">Packet Delivery</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="28" x="1151.5" y="152.7129">PDP</text><rect fill="#92E8C6" height="49.2188" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="1109.5" y="3228.8438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="1116.5" y="3250.377">Packet Delivery</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="28" x="1151.5" y="3267.9863">PDP</text><rect fill="#92E8C6" height="66.8281" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="1299.5" y="95.9609"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="1306.5" y="117.4941">Packet Delivery</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83" x="1314" y="135.1035">Authorisation</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="1329.5" y="152.7129">Registry</text><rect fill="#92E8C6" height="66.8281" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="1299.5" y="3228.8438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="1306.5" y="3250.377">Packet Delivery</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83" x="1314" y="3267.9863">Authorisation</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="1329.5" y="3285.5957">Registry</text><rect fill="#92E8C6" height="49.2188" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="1421.5" y="113.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="1428.5" y="135.1035">Packet Delivery</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1459" y="152.7129">Portal</text><rect fill="#92E8C6" height="49.2188" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="1421.5" y="3228.8438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="1428.5" y="3250.377">Packet Delivery</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1459" y="3267.9863">Portal</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1543.5" y="143.1035">Context</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="1546.5" y="160.7129">Broker</text><path d="M1552.5,92.5703 C1552.5,82.5703 1570.5,82.5703 1570.5,82.5703 C1570.5,82.5703 1588.5,82.5703 1588.5,92.5703 L1588.5,118.5703 C1588.5,128.5703 1570.5,128.5703 1570.5,128.5703 C1570.5,128.5703 1552.5,128.5703 1552.5,118.5703 L1552.5,92.5703 " fill="#92E8C6" style="stroke:#181818;stroke-width:1.5;"/><path d="M1552.5,92.5703 C1552.5,102.5703 1570.5,102.5703 1570.5,102.5703 C1570.5,102.5703 1588.5,102.5703 1588.5,92.5703 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1543.5" y="3243.377">Context</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="1546.5" y="3260.9863">Broker</text><path d="M1552.5,3274.0625 C1552.5,3264.0625 1570.5,3264.0625 1570.5,3264.0625 C1570.5,3264.0625 1588.5,3264.0625 1588.5,3274.0625 L1588.5,3300.0625 C1588.5,3310.0625 1570.5,3310.0625 1570.5,3310.0625 C1570.5,3310.0625 1552.5,3310.0625 1552.5,3300.0625 L1552.5,3274.0625 " fill="#92E8C6" style="stroke:#181818;stroke-width:1.5;"/><path d="M1552.5,3274.0625 C1552.5,3284.0625 1570.5,3284.0625 1570.5,3284.0625 C1570.5,3284.0625 1588.5,3284.0625 1588.5,3274.0625 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><rect fill="#FFFFFF" height="262.9219" style="stroke:#181818;stroke-width:1.0;" width="10" x="47" y="800.2266"/><rect fill="#FFFFFF" height="957.7656" style="stroke:#181818;stroke-width:1.0;" width="10" x="243.5" y="475.0078"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="472.5" y="196.1406"/><rect fill="#FFFFFF" height="55.7031" style="stroke:#181818;stroke-width:1.0;" width="10" x="472.5" y="256.8438"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="472.5" y="444.6563"/><rect fill="#FFFFFF" height="63.0547" style="stroke:#181818;stroke-width:1.0;" width="10" x="472.5" y="2563.0547"/><rect fill="#FFFFFF" height="228.1641" style="stroke:#181818;stroke-width:1.0;" width="10" x="708.5" y="2626.1094"/><rect fill="#FFFFFF" height="46.7031" style="stroke:#181818;stroke-width:1.0;" width="10" x="708.5" y="3091.4375"/><rect fill="#FFFFFF" height="126.4063" style="stroke:#181818;stroke-width:1.0;" width="10" x="849.5" y="558.0625"/><rect fill="#FFFFFF" height="700.5469" style="stroke:#181818;stroke-width:1.0;" width="10" x="849.5" y="1432.7734"/><rect fill="#FFFFFF" height="164.8125" style="stroke:#181818;stroke-width:1.0;" width="10" x="1042.5" y="1548.5313"/><rect fill="#FFFFFF" height="99.4063" style="stroke:#181818;stroke-width:1.0;" width="10" x="1160.5" y="2854.2734"/><rect fill="#FFFFFF" height="46.7031" style="stroke:#181818;stroke-width:1.0;" width="10" x="1160.5" y="2984.0313"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="1160.5" y="3061.0859"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="1350.5" y="2953.6797"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="1350.5" y="3030.7344"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="1472.5" y="226.4922"/><rect fill="#FFFFFF" height="132.1094" style="stroke:#181818;stroke-width:1.0;" width="10" x="1472.5" y="312.5469"/><rect fill="#FFFFFF" height="429.7344" style="stroke:#181818;stroke-width:1.0;" width="10" x="1472.5" y="2133.3203"/><rect fill="#FFFFFF" height="30.3516" style="stroke:#181818;stroke-width:1.0;" width="10" x="1565.5" y="3138.1406"/><polygon fill="#181818" points="460.5,192.1406,470.5,196.1406,460.5,200.1406,464.5,196.1406" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="147.5" x2="466.5" y1="196.1406" y2="196.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="154.5" y="191.2842">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80" x="165.5" y="191.2842">Access portal</text><polygon fill="#181818" points="1460.5,222.4922,1470.5,226.4922,1460.5,230.4922,1464.5,226.4922" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="477.5" x2="1466.5" y1="226.4922" y2="226.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="484.5" y="221.6357">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="495.5" y="221.6357">Accesses portal</text><polygon fill="#181818" points="493.5,252.8438,483.5,256.8438,493.5,260.8438,489.5,256.8438" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="487.5" x2="1476.5" y1="256.8438" y2="256.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="499.5" y="251.9873">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="510.5" y="251.9873">Please select login method</text><path d="M10,271.8438 L147,271.8438 L147,280.1953 L137,290.1953 L10,290.1953 L10,271.8438 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="2020.2891" style="stroke:#000000;stroke-width:1.5;" width="1533.5" x="10" y="271.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="92" x="25" y="286.3389">Authentication</text><polygon fill="#181818" points="1460.5,308.5469,1470.5,312.5469,1460.5,316.5469,1464.5,312.5469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="477.5" x2="1466.5" y1="312.5469" y2="312.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="484.5" y="307.6904">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="495.5" y="307.6904">Select "Login with VC"</text><path d="M482,325.5469 L482,416.5469 L832,416.5469 L832,335.5469 L822,325.5469 L482,325.5469 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M822,325.5469 L822,335.5469 L832,335.5469 L822,325.5469 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="329" x="488" y="344.042">When customer selects "Login with Verifiable Credential"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="240" x="488" y="360.3936">the Packet Delivery Portal displays a QR.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="259" x="488" y="376.7451">The QR includes a nonce called &lt;state&gt; that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="304" x="488" y="393.0967">will be used by Packet Delivery system to match the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="488" y="409.4482">start with the end of the login process</text><polygon fill="#181818" points="493.5,440.6563,483.5,444.6563,493.5,448.6563,489.5,444.6563" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="487.5" x2="1476.5" y1="444.6563" y2="444.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="499.5" y="439.7998">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="264" x="510.5" y="439.7998">Display QR including endpoint URL + &lt;state&gt;</text><polygon fill="#181818" points="264.5,471.0078,254.5,475.0078,264.5,479.0078,260.5,475.0078" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="258.5" x2="476.5" y1="475.0078" y2="475.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="270.5" y="470.1514">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="281.5" y="470.1514">Scan QR</text><path d="M36,488.0078 L36,530.0078 L461,530.0078 L461,498.0078 L451,488.0078 L36,488.0078 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M451,488.0078 L451,498.0078 L461,498.0078 L451,488.0078 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="404" x="42" y="506.5029">The customer uses its wallet to scan the QR in Packet Delivery Portal</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="341" x="42" y="522.8545">The wallet uses the URL inside the QR to start the process</text><polygon fill="#181818" points="837.5,554.0625,847.5,558.0625,837.5,562.0625,841.5,558.0625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="253.5" x2="843.5" y1="558.0625" y2="558.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="260.5" y="553.2061">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="271.5" y="553.2061">GET /authentication-requests</text><path d="M719,571.0625 L719,597.0625 L989,597.0625 L989,581.0625 L979,571.0625 L719,571.0625 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M979,571.0625 L979,581.0625 L989,581.0625 L979,571.0625 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249" x="725" y="589.5576">The SIOP authentication process is started</text><line style="stroke:#181818;stroke-width:1.0;" x1="859.5" x2="901.5" y1="641.1172" y2="641.1172"/><line style="stroke:#181818;stroke-width:1.0;" x1="901.5" x2="901.5" y1="641.1172" y2="654.1172"/><line style="stroke:#181818;stroke-width:1.0;" x1="860.5" x2="901.5" y1="654.1172" y2="654.1172"/><polygon fill="#181818" points="870.5,650.1172,860.5,654.1172,870.5,658.1172,866.5,654.1172" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="866.5" y="628.085">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="38" x="877.5" y="619.9092">Create</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="132" x="877.5" y="636.2607">Authenticaton Request</text><polygon fill="#181818" points="264.5,680.4688,254.5,684.4688,264.5,688.4688,260.5,684.4688" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="258.5" x2="853.5" y1="684.4688" y2="684.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="270.5" y="679.6123">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="281.5" y="679.6123">URI + &lt;Request Token&gt;</text><path d="M258,697.4688 L258,739.4688 L718,739.4688 L718,707.4688 L708,697.4688 L258,697.4688 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M708,697.4688 L708,707.4688 L718,707.4688 L708,697.4688 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="439" x="264" y="715.9639">The Request Token contains the DID of Packet Delivery, among other things</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="266" x="264" y="732.3154">The URI is the standard SIOP URI for callback</text><polygon fill="#181818" points="68,796.2266,58,800.2266,68,804.2266,64,800.2266" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="62" x2="242.5" y1="800.2266" y2="800.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="74" y="779.0186">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="92" y="762.667">Resolve DID of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="92" y="779.0186">Packet Delivery in</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="146" x="92" y="795.3701">Trusted Participant List</text><path d="M62,813.2266 L62,1019.2266 L798,1019.2266 L798,823.2266 L788,813.2266 L62,813.2266 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M788,813.2266 L788,823.2266 L798,823.2266 L788,813.2266 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="518" x="68" y="831.7217">This is a Universal Resolver server, that receives a DID and resolves it to a DID Document.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="547" x="68" y="848.0732">The DID Document (as per W3C) contains relevant information about the entity owning the DID,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="63" x="68" y="864.4248">containing:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="361" x="68" y="880.7764">- The Public Key of the entity used to verify its digital signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="292" x="68" y="897.1279">- Status of the entity in the Trusted Participant List</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="68" y="913.4795"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="649" x="68" y="929.8311">The DID Document is extensible, and can contain any public information which may be relevant for the use case.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="618" x="68" y="946.1826">The Universal Resolver server has to be operated by a trusted entity for the customer and for minimizing the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="588" x="68" y="962.5342">required trust in the ecosystem there may be as many nodes as needed operated by different entities.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="473" x="68" y="978.8857">At least one of those trusted entities has to be configured in the wallet of the user.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="715" x="68" y="995.2373">FIWARE uses a Universal Resolver accessing a blockchain network where the Trusted Lists are managed, but Trusted Lists</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="400" x="68" y="1011.5889">can be implemented with any technology suitable for the ecosysmen.</text><polygon fill="#181818" points="231.5,1059.1484,241.5,1063.1484,231.5,1067.1484,235.5,1063.1484" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="52" x2="237.5" y1="1063.1484" y2="1063.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="59" y="1050.1162">11</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="90" x="77" y="1041.9404">DID Document</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="10" x="171" y="1041.9404">of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="77" y="1058.292">Packet Delivery Co</text><line style="stroke:#181818;stroke-width:1.0;" x1="253.5" x2="295.5" y1="1093.5" y2="1093.5"/><line style="stroke:#181818;stroke-width:1.0;" x1="295.5" x2="295.5" y1="1093.5" y2="1106.5"/><line style="stroke:#181818;stroke-width:1.0;" x1="254.5" x2="295.5" y1="1106.5" y2="1106.5"/><polygon fill="#181818" points="264.5,1102.5,254.5,1106.5,264.5,1110.5,260.5,1106.5" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="260.5" y="1088.6436">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="278.5" y="1088.6436">Verify Authentication Request</text><path d="M258,1119.5 L258,1259.5 L850,1259.5 L850,1129.5 L840,1119.5 L258,1119.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M840,1119.5 L840,1129.5 L850,1129.5 L840,1119.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="264" y="1137.9951">The wallet checks:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="296" x="264" y="1154.3467">- the digital signature of the Authentication Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="571" x="264" y="1170.6982">- that the DID inside the request matches the DID inside the DID Document from Universal Resolver</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="544" x="264" y="1187.0498">- any additional info inside the request against the DID Document, as required by the use case</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="264" y="1203.4014"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="290" x="264" y="1219.7529">Now the wallet knows that Packet Delivery Co is a</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="538" x="264" y="1236.1045">trusted participant entity and that it signed the request and the request has not been modified</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="264" y="1252.4561">since it was signed.</text><line style="stroke:#181818;stroke-width:1.0;" x1="253.5" x2="295.5" y1="1304.0156" y2="1304.0156"/><line style="stroke:#181818;stroke-width:1.0;" x1="295.5" x2="295.5" y1="1304.0156" y2="1317.0156"/><line style="stroke:#181818;stroke-width:1.0;" x1="254.5" x2="295.5" y1="1317.0156" y2="1317.0156"/><polygon fill="#181818" points="264.5,1313.0156,254.5,1317.0156,264.5,1321.0156,260.5,1317.0156" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="260.5" y="1290.9834">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="187" x="278.5" y="1282.8076">Create Authentication Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="278.5" y="1299.1592">with &lt;vp_token&gt;</text><path d="M258,1330.0156 L258,1405.0156 L611,1405.0156 L611,1340.0156 L601,1330.0156 L258,1330.0156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M601,1330.0156 L601,1340.0156 L611,1340.0156 L601,1330.0156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="300" x="264" y="1348.5107">The wallet creates a SIOP Authentication Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="327" x="264" y="1364.8623">The vp_token includes one or more Verifiable Credentials</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="332" x="264" y="1381.2139">In this case there is only one Verifiable Credential, issued</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="264" y="1397.5654">by Happy Pets to its customer</text><polygon fill="#181818" points="837.5,1428.7734,847.5,1432.7734,837.5,1436.7734,841.5,1432.7734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="248.5" x2="843.5" y1="1432.7734" y2="1432.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="255.5" y="1427.917">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="288" x="273.5" y="1427.917">POST &lt;Authentication Response&gt; /siop-sessions</text><path d="M253,1445.7734 L253,1487.7734 L597,1487.7734 L597,1455.7734 L587,1445.7734 L253,1445.7734 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M587,1445.7734 L587,1455.7734 L597,1455.7734 L587,1445.7734 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="323" x="259" y="1464.2686">The URI to which the POST is done was specified in the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="316" x="259" y="1480.6201">Authentication Request that was received by the wallet</text><polygon fill="#181818" points="1030.5,1544.5313,1040.5,1548.5313,1030.5,1552.5313,1034.5,1548.5313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="859.5" x2="1036.5" y1="1548.5313" y2="1548.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="866.5" y="1527.3232">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="884.5" y="1510.9717">Resolve DID of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="884.5" y="1527.3232">Happy Pets in</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="146" x="884.5" y="1543.6748">Trusted Participant List</text><path d="M431,1561.5313 L431,1669.5313 L1037,1669.5313 L1037,1571.5313 L1027,1561.5313 L431,1561.5313 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1027,1561.5313 L1027,1571.5313 L1037,1571.5313 L1027,1561.5313 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="544" x="437" y="1580.0264">This can be a Universal Resolver operated by Packet Delivery Co or by any entity trusted by it.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="395" x="437" y="1596.3779">For maximum level of trust, the node is operated by Packet Delivery.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="455" x="437" y="1612.7295">The Verifiable Credential received from the user was signed by Happy Pets and</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="437" y="1629.0811">includes the DID of Happy Pets.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="585" x="437" y="1645.4326">Packet Delivery retrieves the DID Document for that DID to check that it is a trusted participant entity.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="509" x="437" y="1661.7842">In addition it checks the digital signature using the Public Key inside the DID Document.</text><polygon fill="#181818" points="870.5,1709.3438,860.5,1713.3438,870.5,1717.3438,866.5,1713.3438" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="864.5" x2="1046.5" y1="1713.3438" y2="1713.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="876.5" y="1700.3115">16</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="90" x="894.5" y="1692.1357">DID Document</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="894.5" y="1708.4873">with public key</text><line style="stroke:#181818;stroke-width:1.0;" x1="859.5" x2="901.5" y1="1760.0469" y2="1760.0469"/><line style="stroke:#181818;stroke-width:1.0;" x1="901.5" x2="901.5" y1="1760.0469" y2="1773.0469"/><line style="stroke:#181818;stroke-width:1.0;" x1="860.5" x2="901.5" y1="1773.0469" y2="1773.0469"/><polygon fill="#181818" points="870.5,1769.0469,860.5,1773.0469,870.5,1777.0469,866.5,1773.0469" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="866.5" y="1747.0146">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="33" x="884.5" y="1738.8389">Verify</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="884.5" y="1755.1904">Authentication Response</text><path d="M531,1786.0469 L531,1877.0469 L1178,1877.0469 L1178,1796.0469 L1168,1786.0469 L531,1786.0469 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1168,1786.0469 L1168,1796.0469 L1178,1796.0469 L1168,1786.0469 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="573" x="537" y="1804.542">The VC issued by Happy Pets to the customer includes the Public Key associated to the customer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="324" x="537" y="1820.8936">and that was used to sign the Authentication Response.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="551" x="537" y="1837.2451">The Public Key of the customer was verified when the customer was onboarded by Happy Pets.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="626" x="537" y="1853.5967">For maximum privacy, SIOP (customer) can have a different key for each company where she is a customer.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="500" x="537" y="1869.9482">In each onboarding process the SIOP can generate a different key pair (pairwise DIDs).</text><line style="stroke:#181818;stroke-width:1.0;" x1="859.5" x2="901.5" y1="1905.1563" y2="1905.1563"/><line style="stroke:#181818;stroke-width:1.0;" x1="901.5" x2="901.5" y1="1905.1563" y2="1918.1563"/><line style="stroke:#181818;stroke-width:1.0;" x1="860.5" x2="901.5" y1="1918.1563" y2="1918.1563"/><polygon fill="#181818" points="870.5,1914.1563,860.5,1918.1563,870.5,1922.1563,866.5,1918.1563" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="866.5" y="1900.2998">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="884.5" y="1900.2998">Generate Access Token</text><path d="M565,1931.1563 L565,1973.1563 L1144,1973.1563 L1144,1941.1563 L1134,1931.1563 L565,1931.1563 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1134,1931.1563 L1134,1941.1563 L1144,1941.1563 L1134,1931.1563 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="558" x="571" y="1949.6514">The RP component generates an Access Token in JWT format signed by the RP component and</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="485" x="571" y="1966.0029">including the information of the Verifiable Credential needed to perform authorization.</text><polygon fill="#181818" points="259.5,1997.2109,249.5,2001.2109,259.5,2005.2109,255.5,2001.2109" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="253.5" x2="848.5" y1="2001.2109" y2="2001.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="265.5" y="1996.3545">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="283.5" y="1996.3545">HTTP 200 with &lt;access token&gt;</text><path d="M253,2014.2109 L253,2089.2109 L685,2089.2109 L685,2024.2109 L675,2014.2109 L253,2014.2109 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M675,2014.2109 L675,2024.2109 L685,2024.2109 L675,2014.2109 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="345" x="259" y="2032.7061">The wallet receives the response to the POST indicating the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="259" y="2049.0576">success or failure of the process.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="411" x="259" y="2065.4092">The web portal will refresh its content based on the information received</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="259" y="2081.7607">by the Packet Delivery system.</text><polygon fill="#181818" points="1460.5,2129.3203,1470.5,2133.3203,1460.5,2137.3203,1464.5,2133.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="854.5" x2="1466.5" y1="2133.3203" y2="2133.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="861.5" y="2120.2881">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="879.5" y="2112.1123">Notify with Verifiable Credential and</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="45" x="879.5" y="2128.4639">&lt;state&gt;</text><path d="M586,2146.3203 L586,2286.3203 L1123,2286.3203 L1123,2156.3203 L1113,2146.3203 L586,2146.3203 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1113,2146.3203 L1113,2156.3203 L1123,2156.3203 L1113,2146.3203 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="485" x="592" y="2164.8154">The RP component of Packet Delivery notifies the Portal to refresh the login page so</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="592" y="2181.167">it can present the services to the customer.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218" x="592" y="2197.5186">The notification includes the following:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="516" x="592" y="2213.8701">- the &lt;state&gt; nonce that was generated by the portal when it generated the QR code. The</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="397" x="592" y="2230.2217">portal uses the &lt;state&gt; nonce to know what login session is notified.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="232" x="592" y="2246.5732">- The &lt;Access Token&gt; generated before</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="592" y="2262.9248"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="319" x="592" y="2279.2764">The notification URL is configured in the RP component</text><path d="M586,2304.1328 L586,2493.1328 L1123,2493.1328 L1123,2314.1328 L1113,2304.1328 L586,2304.1328 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1113,2304.1328 L1113,2314.1328 L1123,2314.1328 L1113,2304.1328 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="504" x="592" y="2322.6279">The authentication process has been finished and we still have to perform authorisation.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213" x="592" y="2338.9795">At this point, Packet Delivery knows:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="281" x="604" y="2355.3311">1. That Happy Pets is a trusted participant entity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="302" x="604" y="2371.6826">2. That happy Pets says that the user is a customer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="246" x="604" y="2388.0342">3. The category of customer (Normal/Gold)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="313" x="604" y="2404.3857">4. Any user info encoded into the VC, like customer id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="592" y="2420.7373"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="457" x="592" y="2437.0889">However, Packet Delivery still does not know Happy Pets can issue credentials</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="516" x="592" y="2453.4404">of type Gold (and also Normal). We will check this when the customer chooses a specific</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="476" x="592" y="2469.792">service, which could be avaliable to all customers (Normal) or only Gold customers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="592" y="2486.1436"> </text><path d="M430,2506 L559,2506 L559,2514.3516 L549,2524.3516 L430,2524.3516 L430,2506 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="706.8438" style="stroke:#000000;stroke-width:1.5;" width="1177.5" x="430" y="2506"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="84" x="445" y="2520.4951">Authorisation</text><polygon fill="#181818" points="493.5,2559.0547,483.5,2563.0547,493.5,2567.0547,489.5,2563.0547" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="487.5" x2="1476.5" y1="2563.0547" y2="2563.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="499.5" y="2550.0225">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="320" x="517.5" y="2541.8467">Refresh the screen with services available to customers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="517.5" y="2558.1982">and include &lt;Access Token&gt;</text><polygon fill="#181818" points="696.5,2622.1094,706.5,2626.1094,696.5,2630.1094,700.5,2626.1094" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="477.5" x2="702.5" y1="2626.1094" y2="2626.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="484.5" y="2604.9014">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="502.5" y="2588.5498">Customer selects</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="502.5" y="2604.9014">"Change PTA" on delivery order</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="502.5" y="2621.2529">Browser sends &lt;Access Token&gt;</text><path d="M460,2639.1094 L460,2681.1094 L967,2681.1094 L967,2649.1094 L957,2639.1094 L460,2639.1094 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M957,2639.1094 L957,2649.1094 L967,2649.1094 L957,2639.1094 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="344" x="466" y="2657.6045">The Policy Enforcement Point (PEP) intercepts request and</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="486" x="466" y="2673.9561">checks that the request includes an &lt;Access Token&gt; signed by Packet Delivery RP</text><line style="stroke:#181818;stroke-width:1.0;" x1="718.5" x2="760.5" y1="2725.5156" y2="2725.5156"/><line style="stroke:#181818;stroke-width:1.0;" x1="760.5" x2="760.5" y1="2725.5156" y2="2738.5156"/><line style="stroke:#181818;stroke-width:1.0;" x1="719.5" x2="760.5" y1="2738.5156" y2="2738.5156"/><polygon fill="#181818" points="729.5,2734.5156,719.5,2738.5156,729.5,2742.5156,725.5,2738.5156" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="725.5" y="2712.4834">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47" x="743.5" y="2704.3076">Validate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="743.5" y="2720.6592">&lt;Access Token&gt;</text><path d="M521,2751.5156 L521,2810.5156 L906,2810.5156 L906,2761.5156 L896,2751.5156 L521,2751.5156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M896,2751.5156 L896,2761.5156 L906,2761.5156 L896,2751.5156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="527" y="2770.0107">The Policy Enforcement Point (PEP) asks the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="364" x="527" y="2786.3623">Policy Decision Point (PDP) to evaluate if the &lt;Access Token&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="354" x="527" y="2802.7139">authorizes caller to access the target service ("Change PTA")</text><polygon fill="#181818" points="1148.5,2850.2734,1158.5,2854.2734,1148.5,2858.2734,1152.5,2854.2734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="713.5" x2="1154.5" y1="2854.2734" y2="2854.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="720.5" y="2841.2412">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="279" x="738.5" y="2833.0654">Evaluate authorisation request for "Change PTA"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="738.5" y="2849.417">with &lt;Access Token&gt;</text><path d="M953,2867.2734 L953,2909.2734 L1377,2909.2734 L1377,2877.2734 L1367,2867.2734 L953,2867.2734 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1367,2867.2734 L1367,2877.2734 L1377,2877.2734 L1367,2867.2734 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="403" x="959" y="2885.7686">Use information in &lt;Access Token&gt; to evaluate policies associated to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="959" y="2902.1201">customer roles in the token.</text><polygon fill="#181818" points="1338.5,2949.6797,1348.5,2953.6797,1338.5,2957.6797,1342.5,2953.6797" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1165.5" x2="1344.5" y1="2953.6797" y2="2953.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="1172.5" y="2940.6475">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="1190.5" y="2932.4717">Verify if issuer is allowed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="1190.5" y="2948.8232">to issue the credential</text><polygon fill="#181818" points="1181.5,2980.0313,1171.5,2984.0313,1181.5,2988.0313,1177.5,2984.0313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1175.5" x2="1354.5" y1="2984.0313" y2="2984.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="1187.5" y="2979.1748">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1205.5" y="2979.1748"> </text><polygon fill="#181818" points="1338.5,3026.7344,1348.5,3030.7344,1338.5,3034.7344,1342.5,3030.7344" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1165.5" x2="1344.5" y1="3030.7344" y2="3030.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="1172.5" y="3017.7021">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="1190.5" y="3009.5264">Verify if role in the VC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="1190.5" y="3025.8779">is allowed access</text><polygon fill="#181818" points="1181.5,3057.0859,1171.5,3061.0859,1181.5,3065.0859,1177.5,3061.0859" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1175.5" x2="1354.5" y1="3061.0859" y2="3061.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="1187.5" y="3056.2295">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1205.5" y="3056.2295"> </text><polygon fill="#181818" points="729.5,3087.4375,719.5,3091.4375,729.5,3095.4375,725.5,3091.4375" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="723.5" x2="1164.5" y1="3091.4375" y2="3091.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="735.5" y="3086.5811">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="753.5" y="3086.5811">Authorisation granted</text><polygon fill="#181818" points="1553.5,3134.1406,1563.5,3138.1406,1553.5,3142.1406,1557.5,3138.1406" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="713.5" x2="1559.5" y1="3138.1406" y2="3138.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="720.5" y="3125.1084">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="738.5" y="3116.9326">Forward original request:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="738.5" y="3133.2842">Change PTA on delivery order</text><polygon fill="#181818" points="488.5,3164.4922,478.5,3168.4922,488.5,3172.4922,484.5,3168.4922" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="482.5" x2="1569.5" y1="3168.4922" y2="3168.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="494.5" y="3163.6357">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="512.5" y="3163.6357">Change confirmed</text><path d="M482,3181.4922 L482,3207.4922 L608,3207.4922 L608,3191.4922 L598,3181.4922 L482,3181.4922 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M598,3181.4922 L598,3191.4922 L608,3191.4922 L598,3181.4922 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="488" y="3199.9873">Change performed</text><!--MD5=[464efe02ee565f7176b1baabc794d171]
@startuml vc_change_pta

title Packet Delivery - HappyPets customer changes PTA

autonumber 1
skinparam SequenceBoxBorderColor transparent

database "Universal\nResolver" as DIDR

box User #MistyRose
    actor "Prime Customer" as primeCustomer #f7a6a6
    participant "Customer\nSIOP" as customerSIOP #f7a6a6
    participant "Customer\nBrowser" as customerBrowser #f7a6a6
endbox

box PacketDelivery #ebfcef
    boundary "Packet Delivery\nPEP" as packetDeliveryPEP #92e8c6
    participant "Packet Delivery\nRP" as packetDeliverySIOP #92e8c6
    database "Packet Delivery\nUniversal\nResolver" as DIDR_pack #92e8c6
    participant "Packet Delivery\nPDP" as packetDeliveryPDP #92e8c6
    participant "Packet Delivery\nAuthorisation\nRegistry" as packetDeliveryAR #92e8c6
    participant "Packet Delivery\nPortal" as packetDeliveryPortal #92e8c6
    database "Context\nBroker" as contextBroker #92e8c6
endbox

'###########################################################

'(1,2,3)
'Visit the Packet Delivery Portal and select logon method
primeCustomer- ->customerBrowser ++: Access portal
customerBrowser->packetDeliveryPortal - -++: Accesses portal
packetDeliveryPortal->customerBrowser - -++: Please select login method

group Authentication

    '(4)
    'A QR code is displayed and scanned by the customer to start the login process.
    'The QR code includes the URL of th eendpoint that will start the process when invoked by the SIOP
    customerBrowser->packetDeliveryPortal - -++: Select "Login with VC"
    note right customerBrowser
        When customer selects "Login with Verifiable Credential"
        the Packet Delivery Portal displays a QR.
        The QR includes a nonce called <state> that
        will be used by Packet Delivery system to match the
        start with the end of the login process
    end note

    '(5)
    packetDeliveryPortal->customerBrowser - -++: Display QR including endpoint URL + <state>

    '(6)
    customerBrowser- ->customerSIOP - -++: Scan QR

    'Perform a GET to start the process
    note over customerSIOP
        The customer uses its wallet to scan the QR in Packet Delivery Portal
        The wallet uses the URL inside the QR to start the process
    end note

    '(7)
    customerSIOP -> packetDeliverySIOP ++:GET /authentication-requests

    note over packetDeliverySIOP: The SIOP authentication process is started

    '(8)
    packetDeliverySIOP -> packetDeliverySIOP :Create\nAuthenticaton Request
    '(9)
    return URI + <Request Token>
    note right customerSIOP
        The Request Token contains the DID of Packet Delivery, among other things
        The URI is the standard SIOP URI for callback
    end note

    '(10)
    'Resolve the DID of Packet Delivery
    customerSIOP -> DIDR ++: Resolve DID of\nPacket Delivery in\n**Trusted Participant List**
    note right DIDR
        This is a Universal Resolver server, that receives a DID and resolves it to a DID Document.
        The DID Document (as per W3C) contains relevant information about the entity owning the DID,
        containing:
        - The Public Key of the entity used to verify its digital signature
        - Status of the entity in the Trusted Participant List

        The DID Document is extensible, and can contain any public information which may be relevant for the use case.
        The Universal Resolver server has to be operated by a trusted entity for the customer and for minimizing the
        required trust in the ecosystem there may be as many nodes as needed operated by different entities.
        At least one of those trusted entities has to be configured in the wallet of the user.
        FIWARE uses a Universal Resolver accessing a blockchain network where the Trusted Lists are managed, but Trusted Lists
        can be implemented with any technology suitable for the ecosysmen.
    end note 

    '(11)
    return **DID Document** of\nPacket Delivery Co

    '(12)
    'Verify the Authentication Request using the DID Document
    customerSIOP -> customerSIOP: Verify Authentication Request
    note right customerSIOP
        The wallet checks:
        - the digital signature of the Authentication Request
        - that the DID inside the request matches the DID inside the DID Document from Universal Resolver
        - any additional info inside the request against the DID Document, as required by the use case

        Now the wallet knows that Packet Delivery Co is a
        trusted participant entity and that it signed the request and the request has not been modified
        since it was signed.
    end note

    '(13)
    customerSIOP -> customerSIOP: Create Authentication Response\nwith <vp_token>

    note right customerSIOP
        The wallet creates a SIOP Authentication Response
        The vp_token includes one or more Verifiable Credentials
        In this case there is only one Verifiable Credential, issued
        by Happy Pets to its customer
    end note

    '(14)
    'Perform a POST to send the Authentication Response
    customerSIOP -> packetDeliverySIOP - -++: POST <Authentication Response> /siop-sessions

    note right customerSIOP
        The URI to which the POST is done was specified in the
        Authentication Request that was received by the wallet
    end note

    '(15)
    'Resolve DID of HappyPets to see if it is trusted issuer
    packetDeliverySIOP->DIDR_pack ++: Resolve DID of\nHappy Pets in\n**Trusted Participant List**
    note left DIDR_pack
        This can be a Universal Resolver operated by Packet Delivery Co or by any entity trusted by it.
        For maximum level of trust, the node is operated by Packet Delivery.
        The Verifiable Credential received from the user was signed by Happy Pets and
        includes the DID of Happy Pets.
        Packet Delivery retrieves the DID Document for that DID to check that it is a trusted participant entity.
        In addition it checks the digital signature using the Public Key inside the DID Document.
    end note

    '(16)
    return **DID Document**\nwith public key

    '(17)
    'Verify the Authentication Response from the mobile wallet
    packetDeliverySIOP->packetDeliverySIOP: Verify\nAuthentication Response
    note over packetDeliverySIOP
        The VC issued by Happy Pets to the customer includes the Public Key associated to the customer
        and that was used to sign the Authentication Response.
        The Public Key of the customer was verified when the customer was onboarded by Happy Pets.
        For maximum privacy, SIOP (customer) can have a different key for each company where she is a customer.
        In each onboarding process the SIOP can generate a different key pair (pairwise DIDs).
    end note

    '(18)
    'Generate an Access Token including the information in the Verifiable Credential
    packetDeliverySIOP->packetDeliverySIOP : Generate Access Token
    note over packetDeliverySIOP
        The RP component generates an Access Token in JWT format signed by the RP component and
        including the information of the Verifiable Credential needed to perform authorization.
    end note

    '(19)
    packetDeliverySIOP->customerSIOP : HTTP 200 with <access token>
    deactivate customerSIOP
    note right customerSIOP
        The wallet receives the response to the POST indicating the
        success or failure of the process.
        The web portal will refresh its content based on the information received
        by the Packet Delivery system.
    end note

    '(20)
    'Notify the portal so it refreshes the login page with services available to the customer
    packetDeliverySIOP- ->packetDeliveryPortal - -++: Notify with Verifiable Credential and\n<state>
    note over packetDeliverySIOP
        The RP component of Packet Delivery notifies the Portal to refresh the login page so
        it can present the services to the customer.
        The notification includes the following:
        - the <state> nonce that was generated by the portal when it generated the QR code. The
        portal uses the <state> nonce to know what login session is notified.
        - The <Access Token> generated before

        The notification URL is configured in the RP component
    end note

end group

note over packetDeliverySIOP
   The authentication process has been finished and we still have to perform authorisation.
   At this point, Packet Delivery knows:
      1. That Happy Pets is a trusted participant entity
      2. That happy Pets says that the user is a customer
      3. The category of customer (Normal/Gold)
      4. Any user info encoded into the VC, like customer id

   However, Packet Delivery still does not know Happy Pets can issue credentials
   of type Gold (and also Normal). We will check this when the customer chooses a specific
   service, which could be avaliable to all customers (Normal) or only Gold customers

end note


group Authorisation

   '(21)
    packetDeliveryPortal- ->customerBrowser - -++: Refresh the screen with services available to customers\nand include <Access Token>

   '(22)
    'The customer selects to change the PTA
    customerBrowser->packetDeliveryPEP - -++: Customer selects\n"Change PTA" on delivery order\nBrowser sends <Access Token>
    note over packetDeliveryPEP
        The Policy Enforcement Point (PEP) intercepts request and
        checks that the request includes an <Access Token> signed by Packet Delivery RP
    end note

    '(23)
    packetDeliveryPEP->packetDeliveryPEP: Validate\n<Access Token>

    note over packetDeliveryPEP
        The Policy Enforcement Point (PEP) asks the
        Policy Decision Point (PDP) to evaluate if the <Access Token>
        authorizes caller to access the target service ("Change PTA")
    end note

    '(24)
    packetDeliveryPEP->packetDeliveryPDP - -++: Evaluate authorisation request for "Change PTA"\nwith <Access Token>

    note over packetDeliveryPDP
        Use information in <Access Token> to evaluate policies associated to
        customer roles in the token.
    end note

    '(25 and 26)
    'Check policies for this customer
    packetDeliveryPDP->packetDeliveryAR - -++: Verify if issuer is allowed\nto issue the credential
    packetDeliveryAR->packetDeliveryPDP - -++:

    '(27 and 28)
    packetDeliveryPDP->packetDeliveryAR - -++: Verify if role in the VC\nis allowed access
    packetDeliveryAR->packetDeliveryPDP - -++:

    '(29)
    packetDeliveryPDP->packetDeliveryPEP - -++:Authorisation granted

    '(30)
    packetDeliveryPEP->contextBroker - -++:Forward original request:\nChange PTA on delivery order
    '(31)
    contextBroker->customerBrowser - -:Change confirmed

    note right customerBrowser
        Change performed
    end note

end group

@enduml

@startuml vc_change_pta

title Packet Delivery - HappyPets customer changes PTA

autonumber 1
skinparam SequenceBoxBorderColor transparent

database "Universal\nResolver" as DIDR

box User #MistyRose
    actor "Prime Customer" as primeCustomer #f7a6a6
    participant "Customer\nSIOP" as customerSIOP #f7a6a6
    participant "Customer\nBrowser" as customerBrowser #f7a6a6
endbox

box PacketDelivery #ebfcef
    boundary "Packet Delivery\nPEP" as packetDeliveryPEP #92e8c6
    participant "Packet Delivery\nRP" as packetDeliverySIOP #92e8c6
    database "Packet Delivery\nUniversal\nResolver" as DIDR_pack #92e8c6
    participant "Packet Delivery\nPDP" as packetDeliveryPDP #92e8c6
    participant "Packet Delivery\nAuthorisation\nRegistry" as packetDeliveryAR #92e8c6
    participant "Packet Delivery\nPortal" as packetDeliveryPortal #92e8c6
    database "Context\nBroker" as contextBroker #92e8c6
endbox


primeCustomer- ->customerBrowser ++: Access portal
customerBrowser->packetDeliveryPortal - -++: Accesses portal
packetDeliveryPortal->customerBrowser - -++: Please select login method

group Authentication

    customerBrowser->packetDeliveryPortal - -++: Select "Login with VC"
    note right customerBrowser
        When customer selects "Login with Verifiable Credential"
        the Packet Delivery Portal displays a QR.
        The QR includes a nonce called <state> that
        will be used by Packet Delivery system to match the
        start with the end of the login process
    end note

    packetDeliveryPortal->customerBrowser - -++: Display QR including endpoint URL + <state>

    customerBrowser- ->customerSIOP - -++: Scan QR

    note over customerSIOP
        The customer uses its wallet to scan the QR in Packet Delivery Portal
        The wallet uses the URL inside the QR to start the process
    end note

    customerSIOP -> packetDeliverySIOP ++:GET /authentication-requests

    note over packetDeliverySIOP: The SIOP authentication process is started

    packetDeliverySIOP -> packetDeliverySIOP :Create\nAuthenticaton Request
    return URI + <Request Token>
    note right customerSIOP
        The Request Token contains the DID of Packet Delivery, among other things
        The URI is the standard SIOP URI for callback
    end note

    customerSIOP -> DIDR ++: Resolve DID of\nPacket Delivery in\n**Trusted Participant List**
    note right DIDR
        This is a Universal Resolver server, that receives a DID and resolves it to a DID Document.
        The DID Document (as per W3C) contains relevant information about the entity owning the DID,
        containing:
        - The Public Key of the entity used to verify its digital signature
        - Status of the entity in the Trusted Participant List

        The DID Document is extensible, and can contain any public information which may be relevant for the use case.
        The Universal Resolver server has to be operated by a trusted entity for the customer and for minimizing the
        required trust in the ecosystem there may be as many nodes as needed operated by different entities.
        At least one of those trusted entities has to be configured in the wallet of the user.
        FIWARE uses a Universal Resolver accessing a blockchain network where the Trusted Lists are managed, but Trusted Lists
        can be implemented with any technology suitable for the ecosysmen.
    end note 

    return **DID Document** of\nPacket Delivery Co

    customerSIOP -> customerSIOP: Verify Authentication Request
    note right customerSIOP
        The wallet checks:
        - the digital signature of the Authentication Request
        - that the DID inside the request matches the DID inside the DID Document from Universal Resolver
        - any additional info inside the request against the DID Document, as required by the use case

        Now the wallet knows that Packet Delivery Co is a
        trusted participant entity and that it signed the request and the request has not been modified
        since it was signed.
    end note

    customerSIOP -> customerSIOP: Create Authentication Response\nwith <vp_token>

    note right customerSIOP
        The wallet creates a SIOP Authentication Response
        The vp_token includes one or more Verifiable Credentials
        In this case there is only one Verifiable Credential, issued
        by Happy Pets to its customer
    end note

    customerSIOP -> packetDeliverySIOP - -++: POST <Authentication Response> /siop-sessions

    note right customerSIOP
        The URI to which the POST is done was specified in the
        Authentication Request that was received by the wallet
    end note

    packetDeliverySIOP->DIDR_pack ++: Resolve DID of\nHappy Pets in\n**Trusted Participant List**
    note left DIDR_pack
        This can be a Universal Resolver operated by Packet Delivery Co or by any entity trusted by it.
        For maximum level of trust, the node is operated by Packet Delivery.
        The Verifiable Credential received from the user was signed by Happy Pets and
        includes the DID of Happy Pets.
        Packet Delivery retrieves the DID Document for that DID to check that it is a trusted participant entity.
        In addition it checks the digital signature using the Public Key inside the DID Document.
    end note

    return **DID Document**\nwith public key

    packetDeliverySIOP->packetDeliverySIOP: Verify\nAuthentication Response
    note over packetDeliverySIOP
        The VC issued by Happy Pets to the customer includes the Public Key associated to the customer
        and that was used to sign the Authentication Response.
        The Public Key of the customer was verified when the customer was onboarded by Happy Pets.
        For maximum privacy, SIOP (customer) can have a different key for each company where she is a customer.
        In each onboarding process the SIOP can generate a different key pair (pairwise DIDs).
    end note

    packetDeliverySIOP->packetDeliverySIOP : Generate Access Token
    note over packetDeliverySIOP
        The RP component generates an Access Token in JWT format signed by the RP component and
        including the information of the Verifiable Credential needed to perform authorization.
    end note

    packetDeliverySIOP->customerSIOP : HTTP 200 with <access token>
    deactivate customerSIOP
    note right customerSIOP
        The wallet receives the response to the POST indicating the
        success or failure of the process.
        The web portal will refresh its content based on the information received
        by the Packet Delivery system.
    end note

    packetDeliverySIOP- ->packetDeliveryPortal - -++: Notify with Verifiable Credential and\n<state>
    note over packetDeliverySIOP
        The RP component of Packet Delivery notifies the Portal to refresh the login page so
        it can present the services to the customer.
        The notification includes the following:
        - the <state> nonce that was generated by the portal when it generated the QR code. The
        portal uses the <state> nonce to know what login session is notified.
        - The <Access Token> generated before

        The notification URL is configured in the RP component
    end note

end group

note over packetDeliverySIOP
   The authentication process has been finished and we still have to perform authorisation.
   At this point, Packet Delivery knows:
      1. That Happy Pets is a trusted participant entity
      2. That happy Pets says that the user is a customer
      3. The category of customer (Normal/Gold)
      4. Any user info encoded into the VC, like customer id

   However, Packet Delivery still does not know Happy Pets can issue credentials
   of type Gold (and also Normal). We will check this when the customer chooses a specific
   service, which could be avaliable to all customers (Normal) or only Gold customers

end note


group Authorisation

    packetDeliveryPortal- ->customerBrowser - -++: Refresh the screen with services available to customers\nand include <Access Token>

    customerBrowser->packetDeliveryPEP - -++: Customer selects\n"Change PTA" on delivery order\nBrowser sends <Access Token>
    note over packetDeliveryPEP
        The Policy Enforcement Point (PEP) intercepts request and
        checks that the request includes an <Access Token> signed by Packet Delivery RP
    end note

    packetDeliveryPEP->packetDeliveryPEP: Validate\n<Access Token>

    note over packetDeliveryPEP
        The Policy Enforcement Point (PEP) asks the
        Policy Decision Point (PDP) to evaluate if the <Access Token>
        authorizes caller to access the target service ("Change PTA")
    end note

    packetDeliveryPEP->packetDeliveryPDP - -++: Evaluate authorisation request for "Change PTA"\nwith <Access Token>

    note over packetDeliveryPDP
        Use information in <Access Token> to evaluate policies associated to
        customer roles in the token.
    end note

    packetDeliveryPDP->packetDeliveryAR - -++: Verify if issuer is allowed\nto issue the credential
    packetDeliveryAR->packetDeliveryPDP - -++:

    packetDeliveryPDP->packetDeliveryAR - -++: Verify if role in the VC\nis allowed access
    packetDeliveryAR->packetDeliveryPDP - -++:

    packetDeliveryPDP->packetDeliveryPEP - -++:Authorisation granted

    packetDeliveryPEP->contextBroker - -++:Forward original request:\nChange PTA on delivery order
    contextBroker->customerBrowser - -:Change confirmed

    note right customerBrowser
        Change performed
    end note

end group

@enduml

PlantUML version 1.2022.12(Sun Oct 23 20:12:26 CEST 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) Client VM
Default Encoding: Cp1252
Language: en
Country: US
--></g></svg>